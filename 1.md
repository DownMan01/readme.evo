I'll deeply analyze the codebase and database to provide comprehensive workflow documentation for each role in this capstone project.

Now I'll compile a comprehensive workflow documentation for the Voter, Staff, and Administrator roles based on my analysis.

---

# **EVOTAR DIGITAL VOTING PLATFORM - COMPLETE ROLE WORKFLOWS**
## **Capstone Project Documentation**

graph TB
    subgraph "System Entry Point"
        A[New User] -->|Sign Up| B[Registration Form]
        B -->|Submit| C[Pending Status]
    end

    subgraph "Admin Review"
        C -->|Waits for| D[Admin Approval]
        D -->|Approve| E[Approved Voter]
        D -->|Reject| F[Rejected Status]
        F -->|Appeal| B
    end

    subgraph "User Roles"
        E -->|Login as| G[Voter Dashboard]
        H[Staff Login] -->|Access| I[Staff Dashboard]
        J[Admin Login] -->|Access| K[Admin Dashboard]
    end

    subgraph "Election Lifecycle"
        L[Election Created] -->|Pending Start| M[Upcoming]
        M -->|Start Date| N[Active]
        N -->|End Date| O[Completed]
        O -->|Admin Approval| P[Results Published]
    end

---

## **1. VOTER WORKFLOW (Role: 'Voter')**

### **1.1 Registration & Onboarding**

sequenceDiagram
    participant U as New User
    participant S as Signup Form
    participant D as Database
    participant A as Admin Panel
    participant E as Email System

    U->>S: Navigate to /login
    U->>S: Click "Create Account"
    U->>S: Fill Multi-Step Form
    Note over S: Step 1: Personal InfoStep 2: Academic InfoStep 3: ID UploadStep 4: Password
    S->>D: Submit Registration
    D->>D: Create Profile (Pending)
    D->>E: Send Confirmation Email
    E->>U: Email Verification Link
    U->>E: Confirm Email
    D->>A: Notify Admin (Pending User)
    A->>D: Admin Reviews Credentials
    A->>D: Approve/Reject
    D->>U: Notification (Approved/Rejected)

**Registration Flow Steps:**

1. **Access Registration Page** (`/login`)
   - Click "Create Account" button
   - Redirected to multi-step signup form

2. **Complete Multi-Step Form** (`MultiStepSignupForm.tsx`)
   - **Step 1 - Personal Information:**
     - Full Name
     - Student ID (unique, validated for duplicates)
     - Email Address

   - **Step 2 - Academic Information:**
     - Course (8 courses available)
     - Year Level (1st, 2nd, 3rd, 4th Year)
     - Gender

   - **Step 3 - ID Verification:**
     - Upload Student ID image
     - Stored in `student-ids` storage bucket
     - Secure image handling with validation

   - **Step 4 - Account Security:**
     - Create strong password
     - Password confirmation
     - Zod validation for security

3. **Account Creation:**
   - Data submitted to Supabase Auth
   - Triggers `handle_new_user()` database function
   - Profile created with `registration_status: 'Pending'`
   - Email confirmation sent automatically
   - User receives success message

4. **Email Verification:**
   - User checks email for confirmation link
   - Clicks verification link
   - Email confirmed in `auth.users` table

5. **Wait for Admin Approval:**
   - Profile visible in Admin Panel
   - Status: "Pending"
   - User cannot vote until approved

### **1.2 Login & Authentication**

**Login Process:**

1. **Navigate to `/login`**
2. **Enter Credentials:**
   - Student ID (NOT email)
   - Password
3. **Two-Factor Authentication (if enabled):**
   - Enter TOTP code from authenticator app
   - OR use recovery code
4. **Access Dashboard:**
   - Redirected to `/dashboard`
   - Role-based routing (VoterDashboard for voters)

**Login Security Features:**
- Student ID-based authentication (not email)
- Optional 2FA with TOTP
- Recovery codes for 2FA backup
- Audit logging (IP address, user agent, timestamp)
- Session management (24-hour tokens)

### **1.3 Voter Dashboard Interface**

**Navigation Tabs:**
- **Elections** - View and participate in active/upcoming elections
- **Candidates** - Browse candidates by election and position
- **Results** - View completed election results (if published)
- **Settings** - Manage profile and security settings

### **1.4 Viewing Elections**

**Election Visibility Rules:**
- Voters can ONLY see:
  - **Active** elections (currently running)
  - **Upcoming** elections (scheduled to start)
- Voters CANNOT see:
  - **Completed** elections (unless results are published)

**Election Card Information:**
- Election title and description
- Election cover image (if uploaded)
- Start and end date/time
- Eligible voters (All Courses or specific course)
- Election status badge
- "Vote Now" button (Active) or "View Details" (Upcoming)

### **1.5 Voting Process (Anonymous)**

sequenceDiagram
    participant V as Voter
    participant UI as Voting Interface
    participant VS as Voting Session
    participant DB as Database
    participant R as Receipt Generator

    V->>UI: Click "Vote Now"
    UI->>VS: Create Voting Session
    VS->>DB: Generate Session Token
    DB-->>VS: Return Token (24hr expiry)
    VS-->>UI: Session Active
    UI->>V: Display Positions & Candidates
    Note over V: Select candidatesfor each position
    V->>UI: Submit Votes
    UI->>UI: Show Confirmation Dialog
    V->>UI: Confirm Submission
    UI->>DB: cast_multiple_anonymous_votes()
    Note over DB: Votes recordedVoter ID → SessionSession → Votes(No direct link)
    DB->>VS: Mark Session Used
    DB->>R: Generate Receipt
    R->>V: Download PDF Receipt
    R->>DB: Store Receipt Data
    DB-->>V: Success Notification

**Detailed Voting Steps:**

1. **Start Voting Session:**
   - Click "Vote Now" on active election
   - System calls `create_voting_session_safe()` RPC
   - Creates entry in `voting_sessions` table
   - Session token generated (64-character unique string)
   - Session expires in 24 hours
   - One session per voter per election

2. **Eligibility Checks:**
   - User must be a **Voter** (NOT Staff/Admin)
   - Registration status must be **Approved**
   - Election must be **Active**
   - User must not have already voted
   - Course eligibility check (if election is course-specific)

3. **Select Candidates:**
   - **Position-by-position** selection interface
   - **Year-level filtering** for representative positions:
     - 1st Year voters see only "1st Year Representative"
     - 2nd Year voters see only "2nd Year Representative"
     - etc.
   - **Vote limits:**
     - **1 candidate** for most positions (President, Secretary, etc.)
     - **Up to 2 candidates** for Representative positions
   - **Visual feedback:**
     - Selected candidates show green checkmark
     - Disabled candidates when limit reached

4. **Submit Votes:**
   - "Submit My Votes" button enabled only when all positions filled
   - Confirmation dialog shows all selections
   - User confirms or changes selection
   - All votes submitted atomically via `cast_multiple_anonymous_votes()`

5. **Anonymous Vote Recording:**
   - Votes linked to `voter_id` in `votes` table
   - Session marked as `has_voted = true`
   - No direct link between voter and specific candidate choices in audits
   - Audit logs record "vote cast" without revealing choices

6. **Receipt Generation:**
   - **Automatic PDF download** (`receiptGenerator.ts`)
   - **Receipt contents:**
     - Receipt ID (unique identifier)
     - Election title
     - Voting date/time
     - Selected candidates and positions
     - Verification token
     - QR code for verification
   - **Receipt storage:**
     - Encrypted data in `vote_receipts` table
     - Can be verified later at `/verify`

7. **Post-Vote:**
   - Success notification displayed
   - User returned to dashboard
   - Cannot vote again in same election
   - "Vote Already Cast" message shown if they try

### **1.6 Viewing Candidates**

**Candidate Display:**
- Filtered by election selection
- Organized by position (hierarchy-ordered)
- Each candidate card shows:
  - Profile photo (from `candidate-profiles` bucket)
  - Full name
  - Position title
  - Bio/Platform statement
  - Educational background (JHS, SHS)
  - Partylist affiliation
  - "Why Vote Me" statement

**Candidate Visibility Rules:**
- Voters can ONLY see candidates for:
  - **Active** elections
  - **Upcoming** elections
- Voters CANNOT see candidates for **Completed** elections

### **1.7 Viewing Results**

**Result Access Control:**
- Admin must explicitly enable `show_results_to_voters = true`
- Voters can ONLY see results if:
  - Election status is **Completed**
  - AND `show_results_to_voters = true`
- Results show:
  - Vote counts per candidate
  - Winner indicators (highest votes)
  - Total votes cast
  - Voting analytics (if enabled)

### **1.8 Profile Management**

**Voter Settings Interface:**

1. **Profile Overview:**
   - View current profile information
   - Display uploaded ID image
   - Full-size image preview dialog

2. **Update Profile (Approval Required):**
   - **Updatable fields:**
     - Email address
     - Year level
   - **Update process:**
     - Submit update request
     - Creates entry in `profile_update_requests` table
     - Status: "Pending"
     - Staff notified automatically
     - Wait for Staff/Admin approval
   - **Non-updatable fields:**
     - Full name, Student ID, Course, Gender, ID image
     - Must appeal if incorrect

3. **Security Settings:**
   - **Two-Factor Authentication:**
     - Enable/Disable 2FA
     - Setup with QR code
     - Generate recovery codes (10 codes)
     - TOTP using OTPAuth library
   - **Change Password:**
     - Requires current password
     - New password validation
     - 2FA verification if enabled

4. **Activity History:**
   - View recent account activity
   - Shows:
     - Action type (login, logout, vote cast)
     - Timestamp
     - IP address
     - Location (from IP geolocation)
     - Browser and OS information
   - **Security monitoring** for unauthorized access

### **1.9 Appeal Process (Rejected Users)**

**If Registration is Rejected:**

1. **Receive Rejection Notification:**
   - System notification with reason (if provided)
   - Status changed to "Rejected"

2. **Submit Appeal (`AppealForm.tsx`):**
   - Access via Settings page
   - **Resubmit updated information:**
     - New Student ID (if incorrect)
     - New Full Name
     - New Course
     - New Year Level
     - New Gender
     - New ID Image
   - **Validation:**
     - Check for duplicate Student ID
     - All fields required
   - **Submission:**
     - Calls `submit_user_appeal()` RPC
     - Status reset to "Pending"
     - Admin notified of appeal

3. **Wait for Re-Review:**
   - Admin reviews appeal in Admin Panel
   - Can approve or reject again

---

## **2. STAFF WORKFLOW (Role: 'Staff')**

### **2.1 Staff Access & Responsibilities**

**Staff Role Overview:**
- **Purpose:** Assist administrators with election management and voter support
- **Permissions:**
  - View voter activity
  - Approve voter registrations
  - Create election requests (requires admin approval)
  - Add candidates directly
  - View voting progress
  - Approve profile update requests
- **Restrictions:**
  - **CANNOT vote** (even if approved voter)
  - Cannot manage other staff/admin users
  - Cannot publish results
  - Cannot view audit logs
  - Cannot delete elections

### **2.2 Staff Dashboard Interface**

**Dashboard Access:**
- Desktop-only requirement (mobile restricted via `PanelAccessGuard`)
- Single tab: **Profile Update Requests**

**Quick Stats Visible:**
- Total pending profile update requests

### **2.3 Managing Profile Update Requests**

sequenceDiagram
    participant V as Voter
    participant D as Database
    participant S as Staff Panel
    participant N as Notification System

    V->>D: Submit Profile Update
    D->>N: Trigger Notification
    N->>S: Notify Staff (Pending Request)
    S->>D: Fetch Requests
    D-->>S: Return Pending Requests
    S->>S: Review Request Details
    Note over S: View:- Current values- Requested changes- User profile info
    S->>D: Approve/Reject Request
    alt Approve
        D->>D: Update Profile
        D->>N: Notify User (Approved)
    else Reject
        D->>N: Notify User (Rejected)
    end

**Profile Update Review Process:**

1. **Access Staff Panel:**
   - Navigate to Dashboard → "Staff Panel" tab
   - Desktop-only access (mobile users see restriction message)

2. **View Pending Requests (`ProfileUpdateRequestsPanel.tsx`):**
   - List of all profile update requests
   - Filter by status: Pending, Approved, Rejected
   - Each request shows:
     - User's full name and student ID
     - Current email vs. Requested email
     - Current year level vs. Requested year level
     - Request date
     - User's profile information

3. **Review Request Details:**
   - Click to expand request details
   - View user's complete profile
   - Check ID image for verification

4. **Approve Request:**
   - Click "Approve" button
   - Optionally add admin notes
   - System calls `approve_profile_update_request()` RPC
   - Profile updated immediately
   - User notified of approval
   - Audit log created

5. **Reject Request:**
   - Click "Reject" button
   - Add rejection reason (recommended)
   - System calls `reject_profile_update_request()` RPC
   - Profile remains unchanged
   - User notified of rejection with reason
   - Audit log created

### **2.4 Creating Elections (Requires Admin Approval)**

**Staff Election Creation Flow:**

1. **Initiate Election Creation:**
   - Click "Create Election" button in Staff Overview
   - Opens `CreateElectionForm.tsx` dialog

2. **Complete Election Form:**
   - **Basic Information:**
     - Election title
     - Description
     - Election cover photo (optional)
     - Eligible voters (All Courses or specific course)
     - Start date & time
     - End date & time

   - **Positions Configuration:**
     - Add multiple positions
     - For each position:
       - Title (predefined list, hierarchy-ordered)
       - Description
       - Max candidates allowed (1-10)
     - Positions sorted by hierarchy (President → Representatives)

3. **Submit for Approval:**
   - As Staff, election is NOT created immediately
   - Creates entry in `pending_actions` table
   - `action_type: 'create_election'`
   - Cover image uploaded to temporary storage
   - Admin notified of pending request

4. **Wait for Admin Approval:**
   - Request appears in Admin Panel → "Pending Approvals"
   - Admin reviews and approves/rejects
   - Staff notified of decision

5. **If Approved:**
   - Election created in `elections` table
   - Positions created in `positions` table
   - Cover image moved to final location
   - Staff can now add candidates

### **2.5 Adding Candidates (Direct)**

**Staff Candidate Management:**

1. **Access Candidate Form:**
   - Click "Add Candidate" in Staff Overview
   - Opens `AddCandidateForm.tsx` dialog

2. **Select Election and Position:**
   - Choose from **Upcoming elections only**
   - Select position (shows current count / max limit)
   - Positions sorted by hierarchy
   - Full positions disabled

3. **Enter Candidate Information:**
   - **Profile Picture:**
     - Upload candidate photo
     - Stored in `candidate-profiles` bucket
     - Preview before submission

   - **Basic Information:**
     - Full name
     - Partylist affiliation

   - **Educational Background:**
     - JHS school name
     - JHS graduation year
     - SHS school name
     - SHS graduation year

   - **Platform Statements:**
     - Bio/Background
     - "Why Vote Me" statement

4. **Submit Candidate:**
   - **Staff can add directly** (no approval needed)
   - Candidate created in `candidates` table immediately
   - Linked to election and position
   - Image uploaded to storage
   - Success notification displayed

5. **Validation Checks:**
   - Position max candidates limit enforced
   - Required fields validated
   - Image size limit (5MB)
   - File type validation (images only)

---

## **3. ADMINISTRATOR WORKFLOW (Role: 'Administrator')**

### **3.1 Administrator Privileges**

**Full System Control:**
- **User Management:**
  - Approve/reject voter registrations
  - Change user roles (Voter ↔ Staff ↔ Administrator)
  - Resend confirmation emails
  - View all user details
  - Resubmit rejected applications

- **Election Management:**
  - Create elections directly (no approval needed)
  - Edit/delete elections
  - Manage election status
  - Control results visibility
  - Delete elections

- **Candidate Management:**
  - Add candidates directly
  - Edit candidate information
  - Delete candidates

- **System Administration:**
  - View audit logs
  - Approve staff requests
  - Manage pending actions
  - System-wide notifications
  - Security oversight

### **3.2 Administrator Dashboard**

**Desktop-Only Access** (via `PanelAccessGuard`):

**Quick Stats Cards:**
- Pending Users count
- Rejected Users count
- Approved Users count
- Staff Requests (pending actions)

**Navigation Tabs:**
1. **Pending Approvals** - User registrations and staff requests
2. **User Management** - All users with role management
3. **Election Management** - Control election lifecycle
4. **Audit Logs** - Complete system activity history

### **3.3 User Registration Approval**

sequenceDiagram
    participant U as New User
    participant DB as Database
    participant AP as Admin Panel
    participant A as Administrator
    participant N as Notification System

    U->>DB: Submit Registration
    DB->>DB: Create Profile (Pending)
    DB->>N: Notify Admin
    N->>AP: Update Pending Count
    A->>AP: Open Admin Panel
    AP->>DB: Fetch Pending Users
    DB-->>AP: Return User List
    A->>AP: Review User Details
    Note over A: Check:- Student ID- ID Image- Course Info
    alt Approve User
        A->>DB: approve_user_registration()
        DB->>DB: Set Status = Approved
        DB->>N: Notify User (Approved)
        N->>U: "Registration Approved"
    else Reject User
        A->>DB: reject_user_registration()
        DB->>DB: Set Status = Rejected
        DB->>N: Notify User (Rejected + Reason)
        N->>U: "Registration Rejected"
    end
    DB->>DB: Log Audit Action

**Approval Workflow:**

1. **Access Pending Approvals:**
   - Navigate to Admin Panel → "Pending Approvals" tab
   - View list of pending registrations

2. **Review User Application (`UserDetailsDialog.tsx`):**
   - Click on user to view details
   - **Information displayed:**
     - Full profile information
     - Student ID image (full-size preview)
     - Registration date
     - Email confirmation status
     - Course and year level

   - **Validation checks:**
     - Verify Student ID matches ID image
     - Check photo quality and authenticity
     - Verify course eligibility
     - Check for duplicate registrations

3. **Approve User:**
   - Click "Approve" button
   - Optionally add admin notes
   - System calls `approve_user_registration()` RPC
   - User status → "Approved"
   - User can now log in and vote
   - Notification sent to user
   - Audit log created

4. **Reject User:**
   - Click "Reject" button
   - **MUST provide rejection reason** (best practice)
   - System calls `reject_user_registration()` RPC
   - User status → "Rejected"
   - User receives notification with reason
   - User can submit appeal
   - Audit log created

5. **Additional Actions:**
   - **Resend Confirmation Email:**
     - If user hasn't confirmed email
     - Requires 2FA verification
     - Calls Supabase `auth.resend()`

   - **Resubmit Application:**
     - For rejected users who need help
     - Admin can update user's information
     - Resets status to "Pending"

### **3.4 Staff Request Approval**

**Types of Staff Requests:**
1. Election Creation Requests
2. Candidate Addition Requests (deprecated - now direct)
3. Results Publication Requests

**Approval Process:**

1. **View Pending Actions:**
   - Admin Panel → "Pending Approvals" tab
   - Separate section for staff requests
   - Each request shows:
     - Request type
     - Requested by (Staff name)
     - Request date
     - Status
     - Request details (JSON data)

2. **Review Election Creation Request:**
   - View all election details:
     - Title, description
     - Cover image preview
     - Start/end dates
     - Eligible voters
     - Positions list
   - Verify information accuracy

3. **Approve Request:**
   - Click "Approve" button
   - System calls `approve_pending_action()` RPC
   - **Automatic actions:**
     - Election created in database
     - Positions created
     - Cover image moved to final storage
     - Staff notified of approval
     - Audit log created

4. **Reject Request:**
   - Click "Reject" button
   - Add rejection notes
   - System calls `reject_pending_action()` RPC
   - Staff notified with reason
   - Temporary cover image deleted
   - Audit log created

### **3.5 User Management**

**User Management Tab Functions:**

1. **View All Users:**
   - Complete user database
   - **Filtering options:**
     - By registration status (All, Pending, Approved, Rejected)
     - By role (All, Voter, Staff, Administrator)
     - Search by name, email, student ID
   - **Pagination:** 10 users per page

2. **User Information Display:**
   - Full name, Student ID
   - Email and confirmation status
   - Role badge
   - Registration status badge
   - Course and year level
   - Created date

3. **Role Management (`RoleChangeDialog.tsx`):**
   - Click "Change Role" on any user
   - Select new role:
     - Voter
     - Staff
     - Administrator
   - Confirm role change
   - System calls `update_user_role()` RPC
   - Updates both `profiles.role` and `user_roles` table
   - Audit log created
   - **Security:** Prevents privilege escalation

4. **User Actions:**
   - **View Details:** Full profile information
   - **Change Role:** Modify user access level
   - **Resend Email:** For unconfirmed accounts
   - **Resubmit:** Help rejected users

### **3.6 Election Lifecycle Management**

stateDiagram-v2
    [*] --> Upcoming: Admin Creates
    Upcoming --> Active: Start Date Reached
    Active --> Completed: End Date Reached
    Completed --> Published: Admin Enables Results
    Published --> [*]

    note right of Upcoming
        - Admin creates election
        - Staff add candidates
        - Voters can view
    end note

    note right of Active
        - Auto-transition at start_date
        - Voters can vote
        - Real-time vote counting
        - Notification sent
    end note

    note right of Completed
        - Auto-transition at end_date
        - Voting closed
        - Results available to admin/staff
        - Notification sent
    end note

    note right of Published
        - Admin enables visibility
        - Voters can view results
        - Results page accessible
        - Notification sent
    end note

**Election Management Interface:**

1. **Create Election (Direct):**
   - Admins use same `CreateElectionForm.tsx` as staff
   - **Key difference:** No approval needed
   - Election created **immediately** in database
   - Positions created automatically
   - Cover image uploaded directly

2. **Monitor Election Status:**
   - View all elections in Election Management tab
   - Filter by status (All, Upcoming, Active, Completed)
   - **Auto-status updates:**
     - System runs `auto_update_election_statuses()` periodically
     - Upcoming → Active (at start_date)
     - Active → Completed (at end_date)
     - Automatic notifications sent

3. **Manage Results Visibility:**
   - Toggle results visibility for completed elections
   - Click "Show/Hide Results" button
   - System calls `toggle_election_results_visibility()` RPC
   - Sets `show_results_to_voters = true/false`
   - **When enabled:**
     - Voters can see results
     - System sends notification to all voters
     - Results page accessible
   - Audit log created

4. **Delete Elections:**
   - Click "Delete" button
   - Confirmation dialog
   - **Cascade delete:**
     - Removes election
     - Removes positions
     - Removes candidates
     - Removes votes
     - Removes voting sessions
   - Irreversible action

### **3.7 Viewing Audit Logs**

**Audit Log System (`AuditLogsTab.tsx`):**

1. **Access Audit Logs:**
   - Admin Panel → "Audit Logs" tab
   - **Admin-only feature**

2. **Log Information:**
   - **Actor details:**
     - User ID
     - Role (Voter, Staff, Administrator)
     - Full name

   - **Action details:**
     - Action type (login, logout, approve_user, etc.)
     - Resource type (user_profile, election, vote)
     - Resource ID
     - Timestamp

   - **Security details:**
     - IP address
     - User agent (browser/OS)
     - Location (from IP)

   - **Additional data:**
     - JSON details field
     - Admin notes

3. **Filtering and Search:**
   - Filter by action type
   - Filter by date range
   - Search by user
   - Pagination (50 logs per page)

4. **Use Cases:**
   - **Security monitoring:** Detect unauthorized access
   - **Compliance:** Audit trail for regulations
   - **Debugging:** Track system issues
   - **User support:** Verify user actions

### **3.8 System Administration Tasks**

**Additional Admin Responsibilities:**

1. **Notification Management:**
   - Create system-wide notifications
   - Target specific roles
   - Set priority levels
   - Monitor notification delivery

2. **Security Management:**
   - Monitor failed login attempts
   - Review suspicious activity
   - Enforce 2FA policies
   - Manage session security

3. **Data Integrity:**
   - Monitor vote counts
   - Verify election integrity
   - Check for anomalies
   - Generate reports

4. **User Support:**
   - Handle user appeals
   - Resolve account issues
   - Assist with profile updates
   - Manage email confirmations

---

## **4. CROSS-ROLE SECURITY FEATURES**

### **4.1 Role-Based Access Control (RBAC)**

**Permission Matrix:**

| Feature | Voter | Staff | Administrator |
|---------|-------|-------|---------------|
| **Vote in Elections** | ✅ | ❌ | ❌ |
| **View Candidates** | ✅ (Active/Upcoming) | ✅ (All) | ✅ (All) |
| **View Elections** | ✅ (Active/Upcoming) | ✅ (All) | ✅ (All) |
| **View Results** | ✅ (If published) | ✅ (Always) | ✅ (Always) |
| **Create Elections** | ❌ | ✅ (Requires approval) | ✅ (Direct) |
| **Add Candidates** | ❌ | ✅ (Direct) | ✅ (Direct) |
| **Approve Voters** | ❌ | ✅ | ✅ |
| **Approve Profile Updates** | ❌ | ✅ | ✅ |
| **Manage Users** | ❌ | ❌ | ✅ |
| **Change Roles** | ❌ | ❌ | ✅ |
| **View Audit Logs** | ❌ (Own only) | ❌ | ✅ |
| **Delete Elections** | ❌ | ❌ | ✅ |
| **Publish Results** | ❌ | ❌ | ✅ |

### **4.2 Row-Level Security (RLS)**

**Database Security Implementation:**

1. **Profiles Table:**
   - Users can view own profile
   - Staff can view voter profiles
   - Admins can view all profiles
   - Only admins can update profiles (except via RPC)

2. **Elections Table:**
   - Everyone can view elections
   - Only staff/admin can insert/update/delete

3. **Votes Table:**
   - Users can only view own votes
   - Users can only insert own votes
   - Cannot update or delete votes (immutable)
   - Admin/staff cannot see individual votes

4. **Voting Sessions Table:**
   - Users can view/update own sessions
   - Admin/staff can view all sessions (for monitoring)
   - Users cannot delete sessions

5. **Audit Logs:**
   - Users can view own logs only
   - Staff can view voter and staff logs
   - Admins can view all logs

### **4.3 Authentication Security**

**Multi-Factor Authentication (MFA):**
- **TOTP-based 2FA:**
  - QR code setup
  - Compatible with Google Authenticator, Authy, etc.
  - 30-second time windows
  - Uses OTPAuth library

- **Recovery Codes:**
  - 10 unique codes generated
  - One-time use only
  - Stored encrypted in database
  - Used when authenticator unavailable

- **Step-Up Verification:**
  - Required for sensitive actions
  - Temporary verification tokens
  - 15-minute expiry
  - Used for password changes, role changes, etc.

**Session Security:**
- 24-hour session tokens
- Auto-refresh with JWT
- Secure cookie storage
- Session invalidation on logout
- Single session per user per election (voting)

### **4.4 Anonymous Voting System**

**Anonymity Preservation:**

1. **Voting Session Layer:**
   - Session token decouples voter from votes
   - `voting_sessions` links voter_id to session_token
   - Session expires after 24 hours
   - One session per voter per election

2. **Vote Recording:**
   - Votes stored with `voter_id` (for eligibility)
   - No direct link to candidate selection in audit
   - Audit logs show "vote cast" without details

3. **Receipt System:**
   - PDF receipt with vote details (for voter only)
   - Receipt stored encrypted in database
   - Verification possible without revealing voter identity
   - QR code for easy verification

4. **Data Separation:**
   - Vote data separated from voter profile
   - Results aggregated without voter info
   - Analytics use demographics, not individuals

---

## **5. KEY SYSTEM WORKFLOWS**

### **5.1 Complete Voting Workflow**

```
1. Voter Registration → 2. Email Confirmation → 3. Admin Approval → 
4. Voter Login → 5. Browse Elections → 6. Start Voting Session → 
7. Select Candidates → 8. Confirm Votes → 9. Submit Anonymously → 
10. Receive Receipt → 11. View Confirmation
```

### **5.2 Election Lifecycle Workflow**

```
1. Admin/Staff Creates Election → 2. (If Staff) Admin Approves → 
3. Staff Add Candidates → 4. Election Status: Upcoming → 
5. Auto-transition to Active → 6. Voters Cast Votes → 
7. Auto-transition to Completed → 8. Admin Reviews Results → 
9. Admin Publishes Results → 10. Voters View Results
```

### **5.3 Profile Update Workflow**

```
1. Voter Requests Update → 2. Staff Receives Notification → 
3. Staff Reviews Request → 4. Staff Approves/Rejects → 
5. Profile Updated (if approved) → 6. Voter Notified
```

### **5.4 Appeal Workflow**

```
1. User Rejected → 2. User Submits Appeal → 3. Admin Notified → 
4. Admin Reviews New Credentials → 5. Admin Approves/Rejects → 
6. User Status Updated → 7. User Notified
```

---

## **6. TECHNICAL IMPLEMENTATION HIGHLIGHTS**

### **6.1 Database Functions (RPC)**

**Key Supabase Functions:**

1. **`create_voting_session_safe(p_election_id)`**
   - Creates anonymous voting session
   - Returns session token
   - Validates eligibility

2. **`cast_multiple_anonymous_votes(p_session_token, p_votes, p_election_id)`**
   - Submits all votes atomically
   - Validates session
   - Enforces vote limits
   - Marks session as used

3. **`can_user_vote_in_election(p_user_id, p_election_id)`**
   - Checks all eligibility criteria
   - Returns boolean
   - Used for UI logic

4. **`approve_user_registration(p_user_id, p_admin_notes)`**
   - Changes status to Approved
   - Logs audit action
   - Sends notification

5. **`toggle_election_results_visibility(p_election_id, p_show_results)`**
   - Controls result visibility
   - Logs admin action
   - Sends notifications

6. **`auto_update_election_statuses()`**
   - Updates election statuses based on dates
   - Sends notifications
   - Called periodically

### **6.2 React Hooks Architecture**

**Custom Hooks:**

- **`useAuth()`** - Authentication state and methods
- **`usePermissions()`** - Role-based permission checks
- **`useVoting()`** - Voting session management
- **`useUserManagement()`** - Admin user operations
- **`usePendingActions()`** - Staff request handling
- **`useProfileUpdateRequests()`** - Profile update workflow
- **`useElectionManagement()`** - Election CRUD operations
- **`useNotifications()`** - Notification system
- **`useAuditLog()`** - Audit logging

### **6.3 Security Best Practices Implemented**

1. **No Direct Database Access:**
   - All operations via RPC functions
   - RLS policies enforced
   - SQL injection prevented

2. **Secure Image Storage:**
   - Separate storage buckets
   - Pre-signed URLs for access
   - RLS on storage buckets

3. **Password Security:**
   - Bcrypt hashing (Supabase default)
   - Min 8 characters, complexity required
   - Password reset flow with email verification

4. **Audit Trail:**
   - All significant actions logged
   - IP address and user agent recorded
   - Tamper-proof logging

5. **Input Validation:**
   - Zod schema validation
   - Client and server-side checks
   - SQL injection prevention

---

## **7. CONCLUSION**

This comprehensive workflow documentation demonstrates:

- **Role Separation:** Clear distinction between Voter, Staff, and Administrator workflows
- **Security-First Design:** Anonymous voting, 2FA, audit logging, RLS policies
- **User Experience:** Intuitive interfaces for all roles
- **Scalability:** Efficient database design and caching
- **Transparency:** Complete audit trail and receipt verification
- **Flexibility:** Configurable elections, courses, positions

The Evotar platform successfully implements a **secure, transparent, and accessible digital voting system** for Saint Joseph College of Sindangan, Inc., addressing all requirements of a modern election management system while maintaining the highest standards of security and user privacy.
